version: '3.8'

services:
  collab:
    image: collab:${IMAGE_VERSION:-latest}
    networks:
      - collab_default
    ports:
      - "${APP_PORT:-3000}:3000"
    environment:
      # All variables are exported from .env in the deployment workflow
      # and Docker stack deploy will interpolate them here
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - NEXTAUTH_URL=${NEXTAUTH_URL}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      - GITHUB_WEBHOOK_SECRET=${GITHUB_WEBHOOK_SECRET}
      - NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME=${NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME}
      - CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}
      - CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - EMAIL_HOST=${EMAIL_HOST}
      - EMAIL_PORT=${EMAIL_PORT}
      - EMAIL_SECURE=${EMAIL_SECURE}
      - EMAIL_USER=${EMAIL_USER}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD}
      - EMAIL_FROM=${EMAIL_FROM}
      - NEXT_PUBLIC_ONESIGNAL_APP_ID_PROD=${NEXT_PUBLIC_ONESIGNAL_APP_ID_PROD}
      - ONESIGNAL_API_KEY_PROD=${ONESIGNAL_API_KEY_PROD}
      - VAPID_PRIVATE_KEY=${VAPID_PRIVATE_KEY}
      - VAPID_EMAIL=${VAPID_EMAIL}
      - NEXT_PUBLIC_VAPID_PUBLIC_KEY=${NEXT_PUBLIC_VAPID_PUBLIC_KEY}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - PUSHER_APP_ID=${PUSHER_APP_ID}
      - PUSHER_KEY=${PUSHER_KEY}
      - PUSHER_SECRET=${PUSHER_SECRET}
      - PUSHER_CLUSTER=${PUSHER_CLUSTER}
      - NEXT_PUBLIC_HOCUSPOCUS_URL=${NEXT_PUBLIC_HOCUSPOCUS_URL}
      - CHAT_PROJECT_API_KEY=${CHAT_PROJECT_API_KEY}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - WEBHOOK_BASE_URL=${WEBHOOK_BASE_URL}
      - AS_ISSUER=${AS_ISSUER}
      - APP_TOKENS_KEY=${APP_TOKENS_KEY}
      - NEXT_PUBLIC_FEATURE_APPS=${NEXT_PUBLIC_FEATURE_APPS}
      - CSP_REPORT_ONLY=${CSP_REPORT_ONLY}
      - CSP_SCRIPT_SRC=${CSP_SCRIPT_SRC}
      - CSP_STYLE_SRC=${CSP_STYLE_SRC}
      - CSP_IMG_SRC=${CSP_IMG_SRC}
      - CSP_FRAME_ANCESTORS=${CSP_FRAME_ANCESTORS}
      - CSP_FRAME_SRC=${CSP_FRAME_SRC}
      - SEED_DATABASE=${SEED_DATABASE:-false}
      - NODE_ENV=${NODE_ENV:-production}
      - DEBUG=${DEBUG}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

networks:
  collab_default:
    driver: overlay
    attachable: true
